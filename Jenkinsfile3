pipeline {
  agent any

  environment {
    IMAGE_NAME = 'richardthomas1/phpapp'
    DOCKERHUB = credentials('DockerHub')
  }

  stages {
 stage('Docker Login') {
      steps {
        sh 'echo "$DOCKERHUB_PSW" | docker login -u "$DOCKERHUB_USR" --password-stdin'
      }
    }
        stage('Build image') {
      steps {
        sh '''
          docker build \
            -t ${IMAGE_NAME}:${BUILD_NUMBER} \
            -t ${IMAGE_NAME}:latest \
            .
        '''
      }
    }

  stage('Smoke test') {
  steps {
    sh '''
      # Clean up old container if it exists
      docker rm -f phpapp-smoke || true

      # Run container for smoke test (no ports exposed)
      docker run -d --name phpapp-smoke ${IMAGE_NAME}:${BUILD_NUMBER}

      # Give the app a moment to start
      sleep 15

      # Run curl from a *second* container that shares the same network namespace
      set +e
      docker run --rm \
        --network container:phpapp-smoke \
        curlimages/curl:8.9.0 \
        -f http://localhost/ > /dev/null 2>&1
      STATUS=$?
      set -e

      if [ "$STATUS" -ne 0 ]; then
        echo "Smoke test FAILED, container logs:"
        docker logs phpapp-smoke || true
        docker rm -f phpapp-smoke || true
        exit 1
      fi

      echo "Smoke test PASSED"
      docker rm -f phpapp-smoke || true
    '''
  }
}




     
   

    stage('Push image') {
      steps {
        sh '''
          
          docker push ${IMAGE_NAME}:latest
        '''
      }
    }

    stage('Deploy to EC2') {
      steps {
        sshagent(['EC2_SSH_KEY']) {
          sh '''
            ssh -o StrictHostKeyChecking=no ec2-user@ec2-13-50-4-52.eu-north-1.compute.amazonaws.com << 'ENDSSH'
              echo "Deploying to EC2..."
              cd /opt/phpapp
              
              # Pull latest image
              sudo docker-compose pull
              
              # Recreate containers with new image
              sudo docker-compose up -d --force-recreate
              
              # Wait for containers to be ready
              sleep 10
              
              # Check if containers are running
              if sudo docker ps | grep -q phpapp; then
                echo "✅ Deployment successful!"
                sudo docker-compose ps
              else
                echo "❌ Deployment failed!"
                sudo docker-compose logs
                exit 1
              fi
ENDSSH
          '''
        }
      }
    }

    stage('Health Check') {
      steps {
        sh '''
          echo "Running health check..."
          sleep 5
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://ec2-13-50-4-52.eu-north-1.compute.amazonaws.com/ || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Health check PASSED - Application is accessible"
          else
            echo "⚠️  Health check returned HTTP $HTTP_CODE"
            echo "Application may still be starting up..."
          fi
        '''
      }
    }
  }

  post {
    success {
      echo '✅ Pipeline completed successfully!'
      echo 'Application URL: http://ec2-13-50-4-52.eu-north-1.compute.amazonaws.com'
    }
    failure {
      echo '❌ Pipeline failed! Check the logs above.'
    }
    always {
      sh 'docker logout || true'
    }
  }
}
