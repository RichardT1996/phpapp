pipeline {
  agent any

  environment {
    IMAGE_NAME = 'richardthomas1/phpapp-image'
    DOCKERHUB = credentials('DockerHub')
    APP_DIR = '/opt/phpapp'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Docker Login') {
      steps {
        sh 'echo "$DOCKERHUB_PSW" | docker login -u "$DOCKERHUB_USR" --password-stdin'
      }
    }
    
    stage('Build Image') {
      steps {
        sh '''
          docker build \
            -t ${IMAGE_NAME}:${BUILD_NUMBER} \
            -t ${IMAGE_NAME}:latest \
            .
        '''
      }
    }

    stage('Smoke Test') {
      steps {
        sh '''
          docker rm -f phpapp-smoke || true
          docker run -d --name phpapp-smoke ${IMAGE_NAME}:${BUILD_NUMBER}
          sleep 15

          set +e
          docker run --rm \
            --network container:phpapp-smoke \
            curlimages/curl:8.9.0 \
            -f http://localhost/ > /dev/null 2>&1
          STATUS=$?
          set -e

          docker rm -f phpapp-smoke || true

          if [ "$STATUS" -ne 0 ]; then
            echo "❌ Smoke test FAILED"
            exit 1
          fi
          
          echo "✅ Smoke test PASSED"
        '''
      }
    }

    stage('Push Image') {
      steps {
        sh 'docker push ${IMAGE_NAME}:latest'
        sh 'docker push ${IMAGE_NAME}:${BUILD_NUMBER}'
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          cd ${APP_DIR}
          sudo docker-compose pull
          sudo docker-compose up -d --force-recreate
          sleep 10
          sudo docker-compose ps
        '''
      }
    }

    stage('Health Check') {
      steps {
        sh '''
          sleep 10
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Health check PASSED - HTTP $HTTP_CODE"
          else
            echo "⚠️ Health check returned HTTP $HTTP_CODE"
            echo "Checking container status..."
            cd ${APP_DIR}
            sudo docker-compose ps
            sudo docker-compose logs --tail=50 web
            exit 1
          fi
        '''
      }
    }
  }

  post {
    success {
      echo '✅ Pipeline completed successfully!'
      echo 'Application URL: http://ec2-13-50-4-52.eu-north-1.compute.amazonaws.com'
    }
    failure {
      echo '❌ Pipeline failed!'
      sh '''
        echo "Checking logs..."
        cd ${APP_DIR}
        sudo docker-compose logs --tail=100 || true
      '''
    }
    always {
      sh 'docker logout || true'
    }
  }
}